{% extends 'base.html' %}
{% block content %}
<section class="page-head">
  <h2>Run Detail</h2>
  <p class="muted">Replay run progression across steps, tool calls, and emitted events.</p>
</section>

<section class="card">
  <h3>Run {{ run.id }}</h3>
  <div class="meta-grid">
    <p><span class="muted">Status</span><br /><span class="pill {% if run.status == 'succeeded' %}pill-good{% elif run.status == 'failed' %}pill-bad{% elif run.status == 'running' %}pill-warn{% else %}pill-neutral{% endif %}">{{ run.status }}</span></p>
    <p><span class="muted">Task</span><br />{{ run.task }}</p>
  </div>
  {% if run.status not in ['succeeded', 'failed', 'canceled'] %}
  <div class="hero-actions">
    <form method="post" action="/runs/{{ run.id }}/cancel">
      <input type="hidden" name="redirect_to" value="/runs/{{ run.id }}" />
      <button type="submit">Stop Run</button>
    </form>
  </div>
  {% endif %}
</section>

<section class="card">
  <h3>Live Model Output</h3>
  <p id="live-connection-status" class="muted">Connecting to live replay stream...</p>
  <pre id="live-model-output" class="live-stream">Waiting for model output...</pre>
</section>

{% if run_input_error %}
<section class="card">
  <p class="pill pill-bad">{{ run_input_error }}</p>
</section>
{% endif %}

{% if run.status == 'awaiting_input' %}
<section class="card">
  <h3>Agent Needs Input</h3>
  <p class="muted">{{ awaiting_prompt }}</p>
  <form method="post" action="/runs/{{ run.id }}/input" class="form-grid">
    <label>Your reply
      <input name="message" value="{{ run_input_value }}" placeholder="Type your response to continue this run" />
    </label>
    <button type="submit" class="button primary">Continue Run</button>
  </form>
</section>
{% endif %}

<section class="card">
  <h3>Steps</h3>
  <ul class="timeline">
    {% for step in steps %}
      <li class="timeline-item">
        <p><strong>#{{ step.idx }}</strong> <span class="pill pill-neutral">{{ step.type }}</span></p>
        <p class="muted">started {{ step.started_at }}</p>
        {% if step.error %}<div class="error">Error: {{ step.error }}</div>{% endif %}
        {% if step.output_json %}<pre>{{ step.output_json }}</pre>{% endif %}
      </li>
    {% endfor %}
  </ul>
</section>

<section class="card">
  <h3>Tool Calls</h3>
  <ul class="timeline">
    {% for tc in tool_calls %}
      <li class="timeline-item">
        <p><strong>{{ tc.tool_name }}</strong> <span class="muted">{{ tc.created_at }}</span></p>
        <p>
          <span class="pill {% if tc.allowed %}pill-good{% else %}pill-bad{% endif %}">allowed={{ tc.allowed }}</span>
          <span class="pill pill-neutral">{{ tc.latency_ms }}ms</span>
        </p>
        <details><summary>Args/Result</summary><pre>{{ tc.args_json }}
{{ tc.result_json }}</pre></details>
      </li>
    {% endfor %}
  </ul>
</section>

<section class="card">
  <h3>Model Calls</h3>
  <ul class="timeline">
    {% for mc in model_calls %}
      <li class="timeline-item">
        <p><strong>{{ mc.model }}</strong> <span class="muted">{{ mc.created_at }}</span></p>
        <p>
          <span class="pill {% if mc.error %}pill-bad{% else %}pill-good{% endif %}">{% if mc.error %}error{% else %}ok{% endif %}</span>
          <span class="pill pill-neutral">{{ mc.latency_ms }}ms</span>
        </p>
        <details><summary>Request/Response/Usage</summary><pre>{{ mc.request_json }}
{{ mc.response_json }}
{{ mc.usage_json }}</pre></details>
        {% if mc.error %}<div class="error">Error: {{ mc.error }}</div>{% endif %}
      </li>
    {% endfor %}
  </ul>
</section>

<section class="card">
  <h3>Events</h3>
  <ul class="timeline">
    {% for e in events %}
      <li class="timeline-item">
        <p><strong>{{ e.type }}</strong> <span class="muted">{{ e.ts }}</span></p>
        <pre>{{ e.payload_json }}</pre>
      </li>
    {% endfor %}
  </ul>
</section>

<script>
(() => {
  const runId = {{ run.id | tojson }};
  const outputEl = document.getElementById("live-model-output");
  const statusEl = document.getElementById("live-connection-status");
  if (!outputEl || !statusEl || typeof EventSource === "undefined") {
    if (statusEl) {
      statusEl.textContent = "Live stream unavailable in this browser.";
    }
    return;
  }

  const replayUrl = `/api/runs/${encodeURIComponent(runId)}/replay?follow=1&poll_ms=250`;
  const source = new EventSource(replayUrl);
  const seenModelCalls = new Set();
  let hasRenderedOutput = false;

  const appendText = (text) => {
    if (!text) {
      return;
    }
    if (!hasRenderedOutput) {
      outputEl.textContent = "";
      hasRenderedOutput = true;
    }
    outputEl.textContent += text;
    outputEl.scrollTop = outputEl.scrollHeight;
  };

  const appendLine = (text = "") => appendText(`${text}\n`);

  const renderModelCall = (modelCall) => {
    if (!modelCall || typeof modelCall !== "object") {
      return;
    }
    const modelCallId = String(modelCall.id || "");
    if (modelCallId && seenModelCalls.has(modelCallId)) {
      return;
    }
    if (modelCallId) {
      seenModelCalls.add(modelCallId);
    }

    const response = modelCall.response_json || {};
    const model = String(modelCall.model || "model");
    const reasoning = String(response.reasoning_content || "").trim();
    const assistant = String(response.assistant_content || "").trim();

    if (reasoning) {
      appendLine(`[${model} | reasoning]`);
      appendLine(reasoning);
      appendLine();
    }
    if (assistant) {
      appendLine(`[${model} | assistant]`);
      appendLine(assistant);
      appendLine();
    }
    if (!reasoning && !assistant && response.tool_name) {
      appendLine(`[${model} | decision]`);
      appendLine(`Selected tool: ${response.tool_name}`);
      appendLine();
    }
  };

  source.onopen = () => {
    statusEl.textContent = "Live replay connected.";
  };

  source.onmessage = (evt) => {
    let item;
    try {
      item = JSON.parse(evt.data);
    } catch (_err) {
      return;
    }
    if (!item || typeof item !== "object") {
      return;
    }
    if (item.kind === "model_call") {
      renderModelCall(item.data);
      return;
    }
    if (item.kind !== "event") {
      return;
    }

    const eventData = item.data || {};
    const eventType = String(eventData.type || "");
    const payload = eventData.payload_json || {};
    const model = String(payload.model || "model");
    if (eventType === "model.infer.started") {
      appendLine(`[${model}] thinking...`);
      return;
    }
    if (eventType === "model.infer.failed") {
      appendLine(`[${model}] error: ${String(payload.error || "unknown error")}`);
      appendLine();
      return;
    }
    if (eventType === "model.output.started") {
      appendLine(`[${model} | ${String(payload.channel || "output")}]`);
      return;
    }
    if (eventType === "model.output.delta") {
      appendText(String(payload.delta || ""));
      return;
    }
    if (eventType === "model.output.completed") {
      appendLine();
      appendLine();
    }
  };

  source.addEventListener("done", (evt) => {
    let status = "completed";
    try {
      const payload = JSON.parse(evt.data || "{}");
      status = String(payload.status || status);
    } catch (_err) {
      status = "completed";
    }
    statusEl.textContent = `Live replay finished (${status}).`;
    source.close();
  });

  source.onerror = () => {
    statusEl.textContent = "Live replay interrupted. Reload to reconnect.";
  };
})();
</script>
{% endblock %}
