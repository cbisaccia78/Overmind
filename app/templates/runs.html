{% extends 'base.html' %}
{% block content %}
<section class="page-head">
  <h2>Runs</h2>
  <p class="muted">Launch deterministic tasks and inspect lifecycle, tools, and logs.</p>
</section>

<section class="card">
  <h3>Create Run</h3>
  {% if run_error %}
  <p class="pill pill-bad">{{ run_error }}</p>
  {% endif %}
  {% if agents|length == 0 %}
  <p class="muted">Create at least one agent before starting a run.</p>
  <a class="button primary" href="/agents">Create Agent</a>
  {% else %}
  <form method="post" action="/runs" class="form-grid">
    <label>Agent
      <select name="agent_id">
        {% for agent in agents %}
        <option value="{{ agent.id }}" {% if run_form_values.agent_id == agent.id %}selected{% endif %}>{{ agent.name }} ({{ agent.status }})</option>
        {% endfor %}
      </select>
    </label>
    <label>Task <input name="task" value="{{ run_form_values.task }}" /></label>
    <label>
      Step limit
      <input
        id="step-limit-input"
        name="step_limit"
        type="number"
        min="1"
        value="{{ run_form_values.step_limit }}"
        {% if run_form_values.step_limit_infinite %}disabled{% endif %}
      />
    </label>
    <label>
      <input id="step-limit-infinite" name="step_limit_infinite" type="checkbox" value="1" {% if run_form_values.step_limit_infinite %}checked{% endif %} />
      Infinity (no step cap)
    </label>
    <button type="submit" class="button primary">Start Run</button>
  </form>
  <script>
    (() => {
      const limitInput = document.getElementById("step-limit-input");
      const infiniteToggle = document.getElementById("step-limit-infinite");
      if (!limitInput || !infiniteToggle) return;
      const sync = () => {
        const infinite = Boolean(infiniteToggle.checked);
        limitInput.disabled = infinite;
      };
      infiniteToggle.addEventListener("change", sync);
      sync();
    })();
  </script>
  {% endif %}
</section>

<section class="card">
  <h3>Recent Runs</h3>
  <table class="data-table">
    <thead><tr><th>ID</th><th>Task</th><th>Status</th><th>Created</th><th>Action</th></tr></thead>
    <tbody>
      {% for run in runs %}
      <tr>
        <td><a href="/runs/{{ run.id }}">{{ run.id }}</a></td>
        <td>{{ run.task }}</td>
        <td><span class="pill {% if run.status == 'succeeded' %}pill-good{% elif run.status == 'failed' %}pill-bad{% elif run.status == 'running' %}pill-warn{% else %}pill-neutral{% endif %}">{{ run.status }}</span></td>
        <td>{{ run.created_at }}</td>
        <td>
          {% if run.status not in ['succeeded', 'failed', 'canceled'] %}
          <div class="hero-actions">
            {% if run.status == 'awaiting_input' %}
            <a class="button primary" href="/runs/{{ run.id }}">Provide Input</a>
            {% endif %}
            <form method="post" action="/runs/{{ run.id }}/cancel" style="display:inline;">
              <input type="hidden" name="redirect_to" value="/runs" />
              <button type="submit">Stop Run</button>
            </form>
          </div>
          {% else %}
          <span class="muted">â€”</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}
